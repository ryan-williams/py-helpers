#!/usr/bin/env bash

# UV (Python package manager) aliases and functions

# Basic UV commands
alias uvs="uv sync"
alias uvsf="uv sync --frozen"
alias uvsd="uv sync --dev"
alias uvsn="uv sync --no-dev"
uvsg() {
    local args=()
    for g in "$@"; do args+=(--group "$g"); done
    uv sync "${args[@]}"
}  # uvs with group(s) - supports multiple
alias usg=uvsg  # Shorter alias for uvsg

uvse() {
    local args=()
    for e in "$@"; do args+=(--extra "$e"); done
    uv sync "${args[@]}"
}  # uvs with extra(s) - supports multiple
alias use=uvse  # Shorter alias for uvse

# Combined groups and extras with -g and -e flags
uvsge() {
    local args=()
    while [[ $# -gt 0 ]]; do
        case "$1" in
            -g|--group) shift; args+=(--group "$1"); shift ;;
            -e|--extra) shift; args+=(--extra "$1"); shift ;;
            *) echo "Usage: uvsge [-g group] [-e extra] ..."; return 1 ;;
        esac
    done
    uv sync "${args[@]}"
}
alias usge=uvsge  # Shorter alias for combined groups/extras
alias uva="uv add"
alias uvad="uv add --dev"
alias uvr="uv remove"
alias uvrd="uv remove --dev"
alias uvl="uv lock"
alias uvu="uv lock --upgrade-package"
alias uvi="uv install"
alias uvp="uv pip"
alias uvpi="uv pip install"
alias uvpu="uv pip uninstall"
alias uvpl="uv pip list"
alias uvps="uv pip show"
alias uvv="uv venv"
alias uvrun="uv run"
alias ur="uv run"

# UV tool management
alias uvt="uv tool"
alias utl="uv tool list"

# UV with common flags
alias uvsi="uv sync && uv pip install -e ."  # Sync and install editable
alias uvsq="uv sync --quiet"
alias uvsv="uv sync --verbose"

# UV Python version management
alias uvpy="uv python"
alias uvpyl="uv python list"
alias uvpyi="uv python install"
alias uvpyp="uv python pin"

# List available dependency groups
uv_groups() {
    if [ -f "pyproject.toml" ]; then
        yq -p toml -r '.dependency-groups | keys | .[]' pyproject.toml 2>/dev/null || echo "No dependency groups found"
    else
        echo "No pyproject.toml found" >&2
        return 1
    fi
}
alias uvg="uv_groups"

# List available extras
uv_extras() {
    if [ -f "pyproject.toml" ]; then
        yq -p toml -r '.project.optional-dependencies | keys | .[]' pyproject.toml 2>/dev/null || echo "No extras found"
    else
        echo "No pyproject.toml found" >&2
        return 1
    fi
}
alias uve="uv_extras"

# Show current UV project info
uv_info() {
    if [ -f "uv.lock" ] || [ -f "pyproject.toml" ]; then
        echo "UV Project Info:"
        echo "================"
        if [ -f "pyproject.toml" ]; then
            echo "Project: $(grep '^name' pyproject.toml | cut -d'"' -f2 2>/dev/null || echo 'unnamed')"
        fi
        if [ -f ".python-version" ]; then
            echo "Python: $(cat .python-version)"
        elif [ -f "pyproject.toml" ]; then
            echo "Python: $(grep 'requires-python' pyproject.toml | cut -d'"' -f2 2>/dev/null || echo 'not specified')"
        fi
        if [ -d ".venv" ]; then
            echo "Venv: .venv (exists)"
        else
            echo "Venv: .venv (not created)"
        fi
        if [ -f "uv.lock" ]; then
            echo "Lock: uv.lock ($(wc -l < uv.lock) lines)"
        else
            echo "Lock: not found"
        fi

        # Show groups and extras if available
        local groups=$(uv_groups 2>/dev/null)
        if [ -n "$groups" ] && [ "$groups" != "No dependency groups found" ]; then
            echo "Groups: $groups"
        fi
        local extras=$(uv_extras 2>/dev/null)
        if [ -n "$extras" ] && [ "$extras" != "No extras found" ]; then
            echo "Extras: $extras"
        fi
    else
        echo "Not a UV project (no uv.lock or pyproject.toml found)"
    fi
}
alias uvinfo="uv_info"

# Quick UV project initialization
uv_init() {
    local name="${1:-$(basename "$PWD")}"
    uv init --name "$name"
    uv add --dev pytest ruff mypy
    echo "Initialized UV project: $name"
}
alias uvinit="uv_init"

# Source venv version management helpers
uv_rc_dir="$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )"
[ -f "$uv_rc_dir/venv-helpers.sh" ] && source "$uv_rc_dir/venv-helpers.sh"
